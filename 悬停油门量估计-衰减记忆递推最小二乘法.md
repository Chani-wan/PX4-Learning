<h3 align="center"> PX4二次开发 </h3>

<div align="center">
    <h4 style="background-color: #FFFF00; display: inline-block; padding: 5px;">悬停油门量估计-衰减记忆递推最小二乘法</h4>
</div>

#### 一、物理模型构建

​	在PX4中，油门量与推力之间建模为一个线性关系，然后用最小二乘法估计线性模型的参数。

​	假设推力F与油门量T的关系为为：
$$
F=KT
$$
同时定义悬停时油门为 ==$$T_h$$== ,则在悬停时我们可以得到 
$$
F=KT_h=mg
$$

$$
K=mg/T_h
$$

​	在任意时刻，假设油门量为T，推力为F，加速度为a，我们可以得到方程 
$$
F-mg=am 
$$

$$
KT-mg=mg*T/T_h-mg=am
$$

最终可以解算得到
$$
T=T_h(a/g+1)
$$
​	我们可以发现在我们的应⽤场景中，随着时间的推移，我们能逐渐积累许多油⻔量T和加速度a的数据，因此通过最小二乘法我们可以估计出悬停时油门==$$T_h$$==。

#### 二、最小二乘法

​	设有一系列数据 $$X=[x_1,x_2,\cdots x_n]\in\mathbb{R}^{d\times n}\quad Y=[y_1,y_2,\cdots y_n]^T\in\mathbb{R}^n$$ ,我们期望 $$x_i,y_i$$ 呈线性关系：
$$
y_i=w^T \cdot x_i
$$
为了估计最优的$$w$$ ，我们可以解下面的最小二乘问题：
$$
\min_\omega\|X^T\omega-Y\|_2^2
$$
我们令$$L(w)=\|X^T\omega-Y\|_2^2$$  ，根据向量范数的定义$$\|v\|^2=v^Tv$$ ，可展开为
$$
\begin{aligned}
L(\omega) & =(X^T\omega-Y)^T(X^T\omega-Y) \\
 & =(\omega^TX-Y^T)(X^T\omega-Y) \\
 & =\omega^TXX^T\omega-\omega^TXY-Y^TX^T\omega+Y^TY
\end{aligned}
$$
其中，$$w^TXY$$ 是一个标量，标量的转置等于本身。所以$$（w^TXY）^T=Y^TX^Tw$$ ，最后合并同类项可得：
$$
L(\omega)=\omega^T(XX^T)\omega-2\omega^T(XY)+Y^TY
$$
​	==接着需要对$$w$$ 求梯度，并令其为0。这里需要用到两个矩阵求导公式：==
$$
\frac{\partial(\omega^TA\omega)}{\partial\omega}=2A\omega  （当 A 是对称矩阵时，这里 XX^T 必然对称）
$$

$$
\frac{\partial(\omega^Tb)}{\partial\omega}=b
$$

代入公式求导：
$$
\frac{\partial L}{\partial\omega}=2(XX^T)\omega-2(XY)
$$
令梯度为0，可解得：
$$
\omega=(XX^T)^{-1}XY
$$

#### 三、递推最小二乘法

​	我们在上面提到过通过最小二乘法估计悬停时油门==$$T_h$$== ，然而随着时间的累积，数据量越来越多，势必影响计算效率。为了解决这个问题，递推最小二乘法应运而生。	

​	递推最小二乘法的基本原理是：建立具有n-1组数据的最小二乘解和具有n组数据的最小二乘解之间的递推关系，从而在第n组数据到来时，可以直接根据第n-1组数据的解和新来的数据之间的简单递推，得到当前最小二乘问题的解。这个过程可以形式化表达如下：
$$
\omega_{n+1}=\omega_n+\epsilon_{n+1}
$$
​	根据上面最小二乘法我们已经得到了$$w$$ 的解:
$$
\omega_k=(X_kX_k^T)^{-1}X_kY_k
$$
​	为了后面计算的方便，我们令==$$X_kX_k^T=P_k^{-1}$$== ，$$X_kY_k=U_k$$ ,得到：
$$
w_k=P_kU_k
$$
​	关于$$P_k、U_k$$ 我们不难得到下⾯的递推关系:
$$
P_{k+1}^{-1} = P_{k}^{-1} + x_{k+1}x_{k+1}^{T} \\
U_{k+1} = U_{k} + x_{k+1}y_{k+1}\\
w_{k+1}=P_{k+1}U_{k+1}
$$

接下来开始递推：由公式（3）、（4）可得
$$
P_{k+1}=(P_{k}^{-1} + x_{k+1}x_{k+1}^{T})^{-1}\\
=[I-(P_{k}^{-1}+x_{k+1}Ix_{k+1}^{T})^{-1}x_{k+1}Ix_{k+1}^{T}]P_k\\
$$

$$
令K=(P_{k}^{-1}+x_{k+1}Ix_{k+1}^{T})^{-1}x_{k+1}I\\
=P_kx_{k+1}(I+x_{k+1}^{T}P_{k}x_{k+1})^{-1}
=P_{k+1}x_{k+1}
$$

$$
则P_{k+1}=(I-Kx_{k+1}^{T})P_k
$$

最终得到：
$$
w_{k+1}=P_{k+1}U_{k+1}=P_{k+1}(U_{k} + x_{k+1}y_{k+1})\\
=P_{k+1}U_{k}+Ky_{k+1}=(I-Kx_{k+1}^{T})P_kU_{k}+Ky_{k+1}\\
=w_k+K(y_{k+1}-x_{k+1}^{T}w_k)
$$
==补充公式：==
$$
(I+A)^{-1}(I+A)=I=(I+A)-A\\
(I+A)^{-1}=I-(I+A)^{-1}A
\tag{$1$}
$$

$$
(A+B)^{-1}=[A(I+A^{-1}B)]^{-1}
=(I+A^{-1}B)^{-1}A^{-1}
\tag{$2$}
$$

$$
(A+B)^{-1}=(I+A^{-1}B)^{-1}A^{-1}=[I-(I+A^{-1}B)^{-1}A^{-1}B]A^{-1}\\
=(I-(A+B)^{-1}B)A^{-1}
\tag{$3$}
$$

$$
BA^{-1}CDB+B=BA^{-1}(CDB+A)=(BA^{-1}C+D^{-1})DB\\
(BA^{-1}C+D^{-1})^{-1}BA^{-1}=DB(CDB+A)^{-1}
\tag{$4$}
$$

#### 四、衰减记忆递推最⼩⼆乘法

​	递推最⼩⼆乘法成功解决了当数据连续到来时问题求解的效率问题，但随着时间的推移，之间的关系可能发⽣缓慢的变化，⽽我们在递推最⼩⼆乘法中，将所有这些数据都同等对待，这显然是不合适的，为此，我们需要解决下⾯⼀个最⼩⼆乘问题：
$$
\min_\omega\sum_{k=1}^n\|\gamma^{n-k}(\omega^Tx_k-y_k)\|_2^2
$$
定义：$$\Lambda_n=diag([\gamma^n,\gamma^{n-1},\cdots1])$$​ ，则上述问题可以被重新描述为：
$$
\min_\omega\|\Lambda_n(X^T\omega-Y)\|_2^2
$$
上述问题的最优解是：
$$
\omega=(X\Lambda_n^2X^T)^{-1}X\Lambda_n^2Y
$$
令$$P_n=(X\Lambda_n^2X^T)^{-1}$$ ,$$U_n=X\Lambda_n^2Y$$

可得到以下递推关系：
$$
P_{n+1}^{-1}=\gamma^2P_n^{-1}+x_{n+1}x_{n+1}^T\\
U_{n+1}=\gamma^2U_n+x_{n+1}y_{n+1}
$$
关于P矩阵，我们有：
$$
\begin{aligned}
P_{n+1} & =(\gamma^2P_n^{-1}+x_{n+1}x_{n+1}^T)^{-1} \\
 & =\frac{1}{\gamma^2}(I+\frac{1}{\gamma^2}P_nx_{n+1}x_{n+1}^T)^{-1}P_n \\
 & =\frac{1}{\gamma^2}[I-\frac{1}{\gamma^2}(I+\frac{1}{\gamma^2}P_nx_{n+1}x_{n+1}^T)^{-1}P_nx_{n+1}x_{n+1}^T)]P_n \\
 & =\frac{1}{\gamma^2}(I-Kx_{n+1}^T)P_n
\end{aligned}
$$
其中：
$$
\begin{aligned}
\mathrm{K} & =\frac{1}{\gamma^2}(I+\frac{1}{\gamma^2}P_nx_{n+1}x_{n+1}^T)^{-1}P_nx_{n+1} \\
 & =(\gamma^2P_n^{-1}+x_{n+1}x_{n+1}^T)^{-1}x_{n+1} \\
 & =\frac{1}{\gamma^2}P_nx_{n+1}(\frac{1}{\gamma^2}x_{n+1}^TP_nx_{n+1}+I)^{-1} \\
 & =P_nx_{n+1}(x_{n+1}^TP_nx_{n+1}+\gamma^2)^{-1}\\
 & =P_{n+1}x_{n+1}
\end{aligned}
$$
最终可以得到：
$$
\begin{aligned}
\omega_{n+1} & =P_{n+1}U_{n+1} \\
 & =P_{n+1}(\gamma^2U_n+x_{n+1}y_{n+1}) \\
 & =\gamma^2P_{n+1}U_n+Ky_{n+1} \\
 & =(I-Kx_{n+1}^T)P_nU_n+Ky_{n+1} \\
 & =\omega_n+K(y_{n+1}-\omega_nx_{n+1}^T)
\end{aligned}
$$
