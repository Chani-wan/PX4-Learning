<h3 align="center"> PX4二次开发 </h3>

<div align="center">
    <h4 style="background-color: #FFFF00; display: inline-block; padding: 5px;">PX4姿态解算</h4>
</div>

#### 一、从加速度到姿态

<img src="/home/chaniwan/PX4-Learning/assets/image-20251216105125827.png" alt="image-20251216105125827" style="zoom: 33%;" />

​	在四旋翼无人机里，其推力方向必垂直于桨平面。⽽外⼒与加速度成正⽐，因此：⽆⼈机的姿态与其加速度之间具有紧密的耦合关系。

​	如上图，记⽆⼈机受到的推⼒为 $F$，重⼒为 $G$，加速度为 $a$ ，我们有:
$$
F+G=am
$$
则要想使⻜机具有加速度 $a$，我们需要提供的推⼒为：
$$
F=m(a-g)
$$
​	在PX4中，约定的世界坐标系和机体坐标系均为前-右-下(NED)，即z轴指向正下⽅，因此：
$$
g=[0\quad 0\quad 9.81]^T
$$
​	由于⽆⼈机机体坐标系的 $z$ 轴朝向机⾝正下⽅，因此⽆⼈机所受到的外⼒⽅向指向⽆⼈机z轴的反⽅向，因此我们必有：
$$
\boldsymbol{z}_b = - \frac{\boldsymbol{a} - \boldsymbol{g}}{\| \boldsymbol{a} - \boldsymbol{g} \|_2}
$$
​	经过上⾯的推导，我们确定了⽆⼈机⽬标姿态的 $z$ 轴，接下来需要进⼀步确定⽆⼈机⽬标姿态的 $x$ 轴和 $y$ 轴。事实上，如果仅有⼀个加速度⽬标，是⽆法唯⼀确定⽆⼈机的 $x$ 轴和 $y$ 轴，因为理论上⽆⼈机可以绕其 $z$ 轴⾃由旋转⽽不影响其加速度，因此我们需要另外⼀个⾃由度来进⼀步确定⽆⼈机的精确姿态，我们通常选择⽆⼈机的偏航⻆ $\theta $ 作为这个额外的⾃由度。下⾯我们通过两个不同的⽅法来解决下⾯这个问题：



##### ==⽅法⼀：直接求解欧拉⻆==

​	首先约定旋转顺序 Z-Y-X 来对飞机进行旋转，则飞机的最终姿态旋转矩阵可表示为：
$$
\begin{aligned}
{}^WR_{W_3} & =R_Z(\theta)R_Y(\phi)R_X(\psi) \\
 & =
\begin{bmatrix}
\cos\theta & -\sin\theta & 0 \\
\sin\theta & \cos\theta & 0 \\
0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
\cos\phi & 0 & \sin\phi \\
0 & 1 & 0 \\
-\sin\phi & 0 & \cos\phi
\end{bmatrix}
\begin{bmatrix}
1 & 0 & 0 \\
0 & \cos\psi & -\sin\psi \\
0 & \sin\psi & \cos\psi
\end{bmatrix} \\
 & =
\begin{bmatrix}
\cos\theta\cos\phi & y_1 & z_1 \\
\sin\theta\cos\phi & y_2 & z_2 \\
-\sin\phi & y_3 & z_3
\end{bmatrix}
\end{aligned}
$$
由于旋转矩阵一定是正交的，所以机体的 $x$ 轴和 $z$ 轴正交，所以我们可以得到以下方程：
$$
(z_1cos\theta+z_2sin\theta)cos\phi-z_3sin\phi=0
$$
利用上述公式可以解出 $\phi$ ，从而得出相应的机体 $x$ 轴，然后由叉乘可得：
$$
y_b=z_b \times x_b
$$


##### ==⽅法⼆：利⽤欧拉⻆旋转的性质来求解==

<div style="text-align: center;">
    <img src="/home/chaniwan/PX4-Learning/assets/image-20251216132054635.png" alt="image-20251216132054635" style="zoom: 33%;" />
</div>
​	同样我们按照Z-Y-X的顺序旋转，我们会发现每一次旋转都会有一个轴保持不变:
$$
\boldsymbol{z}^{\prime}=\boldsymbol{z}\quad\boldsymbol{y}^{\prime\prime}=\boldsymbol{y}^{\prime}\quad\boldsymbol{x}_b=\boldsymbol{x}^{\prime\prime}
\tag{1}
$$
由于偏航角已知，所以 $x^\prime$ 轴与 $y^\prime$ 轴已知，同时 $x^{\prime\prime}\perp y^{\prime\prime} $ ，再联立（1），我们可以得到：
$$
x_b \perp y^\prime
$$
在最后一次旋转中：我们得到 $x_b \perp z_b$ ，最终由叉乘得到 $x_b$ 、$y_b$ ：
$$
x_b=y^\prime \times z_b \\
y_b=z_b \times x_b
$$
代码实现如下：

<img src="/home/chaniwan/PX4-Learning/assets/image-20251217205919978.png" alt="image-20251217205919978" style="zoom:50%;" />

#### 二、从加速度到油门量

​	由前面的学习我们知道悬停油门量、真实油门量 $z$ 向分量和 $z$ 向加速度的关系如下：
$$
T_z=T_h(a_z/g+1)
$$
在PX4中，我们需要给出的油门量是⼀个表⽰在机体坐标系中的归⼀化向量。⽽由于我们的所有桨叶的桨平⾯与机体均处于同⼀个平⾯，因此在机体坐标系中，这个⽤于表⽰油⻔量的归⼀化向量可以表⽰为:
$$
[0 \quad 0 \quad T]
$$
​	其中， $T$ 是总的油⻔量，也是我们需要利⽤悬停油⻔量的估计值计算得到的油⻔值。这⾥需要注意的是公式所建⽴的关系，是这个油⻔向量在世界坐标系的$z$向分量与$z$向加速度、悬停油⻔之间的关系，因此我们不能直接⽤公式计算。然⽽，$T$ 和 $T_z$ 之间有下⾯的关系：

<img src="/home/chaniwan/PX4-Learning/assets/image-20251217201939237.png" alt="image-20251217201939237" style="zoom: 33%;" />
$$
\frac{T_z}T=z_b(z)
$$

$$
T_z= T*{z_b(z)}
$$

$$
T=\frac{T_z}{z_b(z)}
$$

​	因此，根据上面的推导我们可以得到最终的总油门量 $T$ 。

代码实现如下：

<img src="/home/chaniwan/PX4-Learning/assets/image-20251217205827676.png" alt="image-20251217205827676" style="zoom:50%;" />
